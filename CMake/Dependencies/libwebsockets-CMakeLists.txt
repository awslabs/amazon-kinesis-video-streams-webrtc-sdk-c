cmake_minimum_required(VERSION 3.6.3)

set(CMAKE_OBJECT_PATH_MAX 300)

project(libwebsocket-download NONE)

SET(PATCH_COMMAND git apply --ignore-whitespace ${CMAKE_CURRENT_LIST_DIR}/libwebsockets-old-gcc-fix-cast-cmakelists.patch ${CMAKE_CURRENT_LIST_DIR}/libwebsockets-leak-pipe-fix.patch)

include(ExternalProject)

if (BUILD_STATIC_LIBS)
  set(LWS_WITH_STATIC 1)
  set(LWS_WITH_SHARED 0)
else()
  set(LWS_WITH_STATIC 0)
  set(LWS_WITH_SHARED 1)
  if (USE_OPENSSL)
      find_package(OpenSSL REQUIRED)
  endif()
endif()

if (USE_OPENSSL)
  set(LWS_WITH_MBEDTLS OFF)
else()
  set(LWS_WITH_MBEDTLS ON)
endif()

set(EXT_PTHREAD_INCLUDE_DIR CACHE PATH "C:/tools/pthreads-w32-2-9-1-release/Pre-built.2/include")
set(EXT_PTHREAD_LIBRARIES CACHE PATH "C:/tools/pthreads-w32-2-9-1-release/Pre-built.2/lib/x64/libpthreadGC2.a")
set(OPENSSL_INCLUDE_DIRS CACHE PATH "C:/Program Files/OpenSSL/include")
set(OPENSSL_LIBRARIES CACHE PATH "C:/Program Files/OpenSSL/lib/libssl.lib;C:/Program Files/OpenSSL/lib/libcrypto.lib")

message("USEOPENSSL KKKKKK: ${USE_OPENSSL}")
message("PTHREAD.h !!!!!: ${EXT_PTHREAD_INCLUDE_DIR}")
message("PTHREAD.h !!!!!**********: ${EXT_PTHREAD_LIBRARIES}")
message("OPENSSL ^^^^^^: ${OPENSSL_INCLUDE_DIRS}")
message("OPENSSL SSL @@@@@@@: ${OPENSSL_SSL_LIBRARY}")
message("OPENSSL CRYPTO @@@@@@@: ${OPENSSL_CRYPTO_LIBRARY}")

ExternalProject_Add(project_libwebsockets
    GIT_REPOSITORY    https://github.com/warmcat/libwebsockets.git
    GIT_TAG           v4.2.2
    PREFIX            ${CMAKE_CURRENT_BINARY_DIR}/build
    CMAKE_ARGS
        -DCMAKE_INSTALL_PREFIX=${OPEN_SRC_INSTALL_PREFIX}
        -DLWS_WITH_HTTP2=1
        -DLWS_HAVE_HMAC_CTX_new=1
        -DLWS_HAVE_SSL_EXTRA_CHAIN_CERTS=1
        -DLWS_HAVE_OPENSSL_ECDH_H=1
        -DLWS_HAVE_EVP_MD_CTX_free=1
        -DLWS_WITHOUT_SERVER=1
        -DLWS_WITHOUT_TESTAPPS=1
        -DLWS_WITH_THREADPOOL=1
        -DLWS_WITHOUT_TEST_SERVER_EXTPOLL=1
        -DLWS_WITHOUT_TEST_PING=1
        -DLWS_WITHOUT_TEST_CLIENT=1
        -DLWS_WITH_STATIC=${LWS_WITH_STATIC}
        -DLWS_WITH_SHARED=${LWS_WITH_SHARED}
        -DLWS_STATIC_PIC=1
        -DLWS_WITH_ZLIB=0
        -DLWS_HAVE_EVENTFD=0
        -DLWS_WITH_MBEDTLS=${LWS_WITH_MBEDTLS}
        -DCMAKE_BUILD_TYPE=DEBUG
        -DCMAKE_C_FLAGS=${CMAKE_C_FLAGS}
        -DLWS_HAVE_PTHREAD_H=1 
        -DLWS_EXT_PTHREAD_INCLUDE_DIR="C:\\tools\\pthreads-w32-2-9-1-release\\Pre-built.2\\include"
        -DLWS_EXT_PTHREAD_LIBRARIES="C:\\tools\\pthreads-w32-2-9-1-release\\Pre-built.2\\lib\\x64\\libpthreadGC2.a"
        -DLWS_WITH_MINIMAL_EXAMPLES=1
        -DLWS_OPENSSL_INCLUDE_DIRS="C:\\Program Files\\OpenSSL\\include"
        -DLWS_OPENSSL_LIBRARIES="C:\\Program Files\\OpenSSL\\lib\\libssl.lib;C:\\Program Files\\OpenSSL\\lib\\libcrypto.lib"
    BUILD_ALWAYS      TRUE
    TEST_COMMAND      ""
)