<h1 align="center">
  Cloudwatch Integration with Amazon Kinesis Video Streams C WebRTC SDK
  <br>
</h1>

The SDK integrates with [AWS SDK CPP](https://github.com/aws/aws-sdk-cpp) to publish runtime performance metrics of the SDK and logs generated by the SDK.

## Configuration

The cloudwatch integration demo can be run with different configurations. The list of options that are configurable:
1. `USE_TRICKLE_ICE`: Set this to TRUE, to enable trickle ICE
2. `FORCE_TURN_ONLY`: Set this to TRUE to force TURN usage. By enabling this flag, the connection established would purely be a relay candidate based connection
3. `RUNNER_LABEL`: This label is used as a suffix in the channel name.
4. `SCENARIO_LABEL`: This label is useful in publishing aggregated performance metrics over multiple configurations. For example, if you would like to aggregate outbound frame rate across 5 different cameras, set this label to get an aggregated metric on cloudwatch dashboard
5. `USE_TURN`: Set this to TRUE if the SDK should gather TURN candidates. If set to FALSE, only host and server reflexive candidates are gathered
6. `ENABLE_TTFF_VIA_DC`: Set this to TRUE if timing components of time to first frame should be sent to the JS viewer via data channel. For more information on this feature, refer to <add-link>
7. `USE_IOT`: Set this to TRUE to use IoT credential provider with the SDK. For more information on setting up an IoT thing, check [SetUp IoT thing](https://docs.aws.amazon.com/kinesisvideostreams/latest/dg/how-iot.html)
8. `ENABLE_STORAGE`: Set this to TRUE to run the master peer with storage configuration. For more information on this feature, refer to [WebRTC Storage](https://docs.aws.amazon.com/kinesisvideostreams/latest/dg/API_Operations_Amazon_Kinesis_Video_WebRTC_Storage.html)
9. `ENABLE_METRICS`: Set this to TRUE to allow the demo to collect metrics to publish to cloudwatch.
10. `SAMPLE_PRE_GENERATE_CERT`: Set this to TRUE to allow the SDK to pre-generate certs. For more information on this, refer to [Pre-gen certs](https://github.com/awslabs/amazon-kinesis-video-streams-webrtc-sdk-c?tab=readme-ov-file#use-pre-generated-certificates)
11. `RUN_TIME`: Set this value to the desired run time of the SDK. Set to 0 to collect metrics forever (till application exits by other means)
12. `LOG_GROUP_NAME`: Set this to the desired string to store the logs in cloudwatch. For more information on cloudwatch log groups and streams refer to [cloudwatch logs](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html)
13. `CHANNEL_NAME_PREFIX`: This value is used as a prefix for channel name. The channel name in this demo is of the format <prefix>-<suffix>. The prefix can also be passed in as a command line arg if prefered.
14. `AUDIO_CODEC`: Set the desired audio codec from the list of supported `RTC_CODEC`. The allowed values are available [here](https://awslabs.github.io/amazon-kinesis-video-streams-webrtc-sdk-c/group__PublicEnums.html#ga93240fd6a0e599dfb0c69ca76e406665)
15. `VIDEO_CODEC`: Set the desired video codec from the list of supported `RTC_CODEC`. The allowed values are available [here](https://awslabs.github.io/amazon-kinesis-video-streams-webrtc-sdk-c/group__PublicEnums.html#ga93240fd6a0e599dfb0c69ca76e406665)
16. `DEFAULT_BITRATE`: If sending mock frames, this value is useful to test the SDK under different bitrate. 
17. `DEFAULT_FRAMERATE`: If sending mock frames, this value is useful to test the SDK under different frame rate conditions.

The demo project uses a config header file approach to set these values up. The user of the demo is free to modify the applications to set it up any other way. More information on configuring the demo with a custom config file will be available in the next section.

## Build

To set up this project, in addition to other desired options, run:

```shell
mkdir -p amazon-kinesis-video-streams-demos/canary/webrtc-c/build
cd amazon-kinesis-video-streams-demos/canary/webrtc-c/build
cmake .. -DENABLE_AWS_SDK_INTEG=ON
make
```

The demo comes with a list of different config files users can choose from. The preset config files are available in the [configs](add link here) folder. By default, the demo is configured to run with `default_config.h`. However, demo users are free to set up their own config file and pass in the absolute path to the file while configuring the demo. To do so, do the following:
```shell
cd amazon-kinesis-video-streams-demos/canary/webrtc-c/build
cmake .. -DENABLE_AWS_SDK_INTEG=ON -DCW_CONFIG_HEADER=</path/to/config>
make
```

## Run

To run the demo as master, from the build directory, run:

```shell
./cloudwatch-integ/kvsWebrtcClientMasterCW <channel-name-prefix>
```

OR,  

```shell
./cloudwatch-integ/kvsWebrtcClientMasterCW
```

To run the demo as viewer, from the build directory, run:

```shell
./cloudwatch-integ/kvsWebrtcClientViewerCW <channel-name-prefix>
```

OR,

```shell
./cloudwatch-integ/kvsWebrtcClientViewerCW
```

## Cloudwatch metrics

The Cloudwatch namespace is set to `KinesisVideoSDKCanary`. Each metric listed below will be emitted twice, one with a label dimension and the other with label and channel dimensions. By omitting the channel dimension, metrics that come from different channel names by with the same label will be aggregated. This can be really useful for a scenario where we want to logically group metrics from different runs, e.g. we have a periodic start/stop scenario and we want to run this scenario with different sets of devices. While it's useful to aggregate these metrics, it's also equally important to keep metrics with the channel dimension to keep the granular access to these metrics.

| Category           | Metric                         | Unit              | Frequency (seconds)  | Description                                                                                                                                                                      |
|--------------------|--------------------------------|-------------------|----------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Shutdown           | ExitStatus                     | Count             | -                    | Every time the Canary runs, it'll post exactly once. If successful, the code will be 0x00000000.                                                                                 |
| Initialization     | SignalingInitDelay             | Milliseconds      | -                    | Measure the time it takes for Signaling from creation to connected.                                                                                                              |
| Initialization     | ICEHolePunchingDelay           | Milliseconds      | -                    | Measure the time it takes for ICE agent to successfully connect to the other peer.                                                                                               |
| End to End         | EndToEndFrameLatency           | Milliseconds      | 30                   | The delay from sending the frame to when the frame is received on the other end                                                                                                  |
| End to End         | FrameSizeMatch                 | None              | 30                   | The decoded canary data (header + frame data) at the receiver end is compared with the received size as part of header). If equal, 1.0 is pushed as a metric, else 0.0 is pushed |
| Outbound RTP Stats | FramesPerSecond                | Count_Second      | 60                   | Measures the rate at which frames are sent out from the master. This is calculated using outboundRtpStats                                                                        |
| Outbound RTP Stats | PercentageFrameDiscarded       | Percent           | 60                   | This expresses the percentage of frames that dropped on the sending path within a given time interval. This is calculated using outboundRtpStats                                 |
| Outbound RTP Stats | PercentageFramesRetransmitted  | Percent           | 60                   | This expresses the percentage of frames that are retransmitted on the sending path within a given time interval.  This is calculated using outboundRtpStats                      |
| Outbound RTP Stats | NackPerSecond                  | Count_Second      | 60                   | Rate at which Nacks are received by master. This is calculated using outboundRtpStats                                                                                            |
| Inbound RTP Stats  | IncomingBitRate                | Kilobits_Second   | 60                   | Measures the rate at which frame bits are received by master. This is calculated using inboundRtpStats                                                                           |
| Inbound RTP Stats  | IncomingPacketsPerSecond       | Count_Second      | 60                   | Measures the rate at which packets are received by the master. This is calculated using inboundRtpStats                                                                          |
| Inbound RTP Stats  | IncomingFramesDroppedPerSecond | Count_Second      | 60                   | Rate at which the incoming frames are dropped. This is calculated using inboundRtpStats                                                                                          |
| End to End | SignalingRoundtripLatency | Milliseconds  | 15                   | Measure the roundtrip latency from sending an offer to receive an answer                                                                                                         |
| Shutdown  | ExitStatus                     | Count         | -                    | Every time the Canary runs, it'll post exactly once. If successful, the code will be 0x00000000.                                                                                 |
| Signaling | CreateCallTime                 | Milliseconds  | -                    | Measures time taken to create channel                                                                                                                                            |
| Signaling | GetEndpointCallTime            | Milliseconds  | -                    | Measures time taken to get data endpoint                                                                                                                                         |
| Signaling | GetTokenTime                   | Milliseconds  | -                    | Measures time taken to get credentials (AKID or IoT)                                                                                                                             |
| Signaling | DescribeCallTime               | Milliseconds  | -                    | Measures time taken to describe the channel                                                                                                                                      |
| Signaling | GetIceConfigCallTime           | Milliseconds  | -                    | Measures time taken to retrieve ICE server config                                                                                                                                |
| Signaling | ConnectCallTime                | Milliseconds  | -                    | Measures time taken to connect to the signaling channel                                                                                                                          |
| Signaling | CreateClientTotalTime          | Milliseconds  | -                    | Measures time taken to retrieve AWS credentials to get started with making signaling calls                                                                                       |
| Signaling | FetchClientTotalTime           | Milliseconds  | -                    | Measures time taken to describe, create channel (if applicable) followed by a describe to get the details, get endpoint and get ICE config                                       |
| Signaling | ConnectClientTotalTime         | Milliseconds  | -                    | Measures time taken to connect to the signaling as master/viewer                                                                                                                 |
| Signaling | OfferToAnswerTime              | Milliseconds  | -                    | Measures time taken to send out an answer once the offer is received.                                                                                                            |
| ICE       | LocalCandidateGatheringTime    | Milliseconds  | -                    | Measures time taken to gather candidate from local interfaces                                                                                                                    |
| ICE       | HostCandidateSetUpTime         | Milliseconds  | -                    | Measures time taken to create socket connections for local candidates and also creates candidate pairs with the available remote candidates                                      |
| ICE       | SrflxCandidateSetUpTime        | Milliseconds  | -                    | Measures time taken to create socket connections for srflx candidates                                                                                                            |
| ICE       | RelayCandidateSetUpTime        | Milliseconds  | -                    | Measures time taken to create socket connections for relay candidates. Candidate pair formation is done periodically in a timer callback as and when relay address is obtained   |
| ICE       | IceServerResolutionTime        | Milliseconds  | -                    | Measures time taken to DNS resolve ICE URLs                                                                                                                                      |
| ICE       | IceCandidatePairNominationTime | Milliseconds  | -                    | Measures time taken to complete nomination of ICE candidate pair                                                                                                                 |
| ICE       | IcecandidateGatheringTime      | Milliseconds  | -                    | Measures time taken from starting gathering to when candidate gathering is done i.e when connectivity checks for all the pairs have been sent out or gathering times out.        |
| ICE       | IceAgentSetUpTime              | Milliseconds  | -                    | Measures time taken to complete connectivity checks                                                                                                                              |
| Peer      | PcCreationTime                 | Milliseconds  | -                    | Measures time taken to create peer connection object after receiving offer                                                                                                       |
| Peer      | DtlsSetupTime                  | Milliseconds  | -                    | Measures time taken to complete DTLS initialization process                                                                                                                      |
| Peer      | ICEHolePunchingDelay           | Milliseconds  | -                    | Measures time taken from start of connectivity checks to when the candidate pair is nominated and peer connection established                                                    |
| Total     | TimeToFirstFrame               | Milliseconds  | -                    | Measures time taken from offer to sending out first frame                                                                                                                        |

## Cloudwatch logs

The demo emits cloudwatch logs to the Log group `WebrtcSDK` by default. To use a different one, you can set the `LOG_GROUP_NAME` in your config file. The log stream name template is `<channelName-mode-timestamp>`, where, mode values are `master`, `viewer` or `StorageMaster` and timestamp is epoch value.





