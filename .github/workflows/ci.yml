name: WebRTC C SDK CI

on:
  push:
    branches:
      - develop
      - master
  pull_request:
    branches:
      - develop
      - master
jobs:
  clang-format-check:
    runs-on: macos-11
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Install clang-format
        run: |
          brew install clang-format
          clang-format --version
      - name: Run clang format check
        run: |
          bash scripts/check-clang.sh

  mac-os-catalina-build:
    runs-on: macos-latest
    env:
      MACOSX_DEPLOYMENT_TARGET: 10.13
      LDFLAGS: "-L/usr/local/opt/openssl/lib"
      CPPFLAGS: "-I/usr/local/opt/openssl/include"
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Build repository
        continue-on-error: true
        run: |
          mkdir build
          cd build
          cmake .. -DBUILD_TEST=TRUE -DCOMPILER_WARNINGS=TRUE -DBUILD_OPENSSL_PLATFORM=darwin64-x86_64-cc
          make
          export DYLD_LIBRARY_PATH="$DYLD_LIBRARY_PATH:`pwd`/../open-source/lib"
          ./tst/webrtc_client_test


  ubuntu-os-build:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Build repository
        run: |
          # TODO: Remove the following line. This is only a workaround for enabling IPv6, https://github.com/travis-ci/travis-ci/issues/8891.
          sudo sh -c 'echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6'
          mkdir build
          cd build
          cmake .. -DBUILD_TEST=TRUE
          make
          export AWS_KVS_LOG_LEVEL=3
          ./tst/webrtc_client_test

  address-sanitizer:
    runs-on: ubuntu-18.04
    env:
      ASAN_OPTIONS: detect_odr_violation=0:detect_leaks=1
      LSAN_OPTIONS: suppressions=../tst/suppressions/LSAN.supp
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Build repository
        run: |
          # TODO: Remove the following line. This is only a workaround for enabling IPv6, https://github.com/travis-ci/travis-ci/issues/8891.
          sudo sh -c 'echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6'
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_TEST=TRUE -DADDRESS_SANITIZER=TRUE
          make
          export AWS_KVS_LOG_LEVEL=3
          ulimit -c unlimited -S
          timeout --signal=SIGABRT 60m ./tst/webrtc_client_test

  undefined-behavior-sanitizer:
    runs-on: ubuntu-18.04
    continue-on-error: true
    env:
      UBSAN_OPTIONS: halt_on_error=1
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Build repository
        continue-on-error: true
        run: |
          # TODO: Remove the following line. This is only a workaround for enabling IPv6, https://github.com/travis-ci/travis-ci/issues/8891.
          sudo sh -c 'echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6'
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_TEST=TRUE -DUNDEFINED_BEHAVIOR_SANITIZER=TRUE
          make
          export AWS_KVS_LOG_LEVEL=3
          ulimit -c unlimited -S
          timeout --signal=SIGABRT 60m ./tst/webrtc_client_test

  thread-sanitizer:
    runs-on: ubuntu-18.04
    env:
      TSAN_OPTIONS: halt_on_error=1:suppressions=../tst/suppressions/TSAN.supp
    steps:
      - name: Clone repository
        uses: actions/checkout@v2
      - name: Build repository
        run: |
          # TODO: Remove the following line. This is only a workaround for enabling IPv6, https://github.com/travis-ci/travis-ci/issues/8891.
          sudo sh -c 'echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6'
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Debug -DBUILD_TEST=TRUE -DTHREAD_SANITIZER=TRUE
          make
          export AWS_KVS_LOG_LEVEL=3
          ulimit -c unlimited -S
          timeout --signal=SIGABRT 60m ./tst/webrtc_client_test