name: WebRTC C Samples

on:
  push:
    branches:
      - develop
      - main
      - 'test-pr-*'
  pull_request:
    branches:
      - develop
      - main

jobs:
  sample-check:
    runs-on: ubuntu-latest
    env:
      AWS_KVS_LOG_LEVEL: 2

    strategy:
      matrix:
        endpoint-type: [ "legacy", "dual-stack" ]

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.x'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set endpoint type
        run: |
          if [ "${{ matrix.endpoint-type }}" = "dual-stack" ]; then
            echo "Using dual-stack endpoints"
            echo "KVS_DUALSTACK_ENDPOINTS=ON" >> $GITHUB_ENV
          else
            echo "Using legacy endpoints"
          fi

      - name: Build repository
        run: |
          mkdir build && cd build
          cmake ..
          make -j

      - name: Sample check
        run: |
          ./scripts/check-sample.sh

  sample-check-no-data-channel:
    runs-on: ubuntu-latest
    env:
      AWS_KVS_LOG_LEVEL: 2
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.x'
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Build repository
        run: |
          sudo sh -c 'echo 0 > /proc/sys/net/ipv6/conf/all/disable_ipv6'
          mkdir build && cd build
          cmake .. -DENABLE_DATA_CHANNEL=OFF
          make
      - name: Sample check without data channel
        run: |
          ./scripts/check-sample.sh

  sample-check-force-turn:
    runs-on: ubuntu-latest
    env:
      AWS_KVS_LOG_LEVEL: 3
      KVS_ICE_TRANSPORT_POLICY: relay
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.x'
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Build repository
        run: |
          mkdir build && cd build
          cmake ..
          make
      - name: Sample check with force TURN
        run: |
          cd build/samples
          ./kvsWebrtcClientMaster SampleChannelForceTurn > master.log 2>&1 &
          MASTER_PID=$!
          sleep 15
          ./kvsWebrtcClientViewer SampleChannelForceTurn > viewer.log 2>&1 &
          VIEWER_PID=$!
          sleep 15

          # Interrupt after 30s, and kill 15s later for safety
          bash -c "sleep 30 && kill -s INT $MASTER_PID $VIEWER_PID" &
          bash -c "sleep 45 && kill -9 $MASTER_PID $VIEWER_PID" &
          wait $MASTER_PID
          MASTER_EXIT=$?
          wait $VIEWER_PID
          VIEWER_EXIT=$?

          if [ $MASTER_EXIT -ne 0 ] || [ $VIEWER_EXIT -ne 0 ]; then
            echo "Sample execution failed"
            cat master.log
            cat viewer.log
            exit 1
          fi
          if grep "local candidate type: relay. remote candidate type: relay" master.log || \
             grep "local candidate type: relay. remote candidate type: relay" viewer.log; then
            echo "SUCCESS: Force TURN verified - relay candidates selected"
            exit 0
          else
            echo "FAILURE: Expected relay candidate pair not found in logs"
            cat master.log
            cat viewer.log
            exit 1
          fi

  valgrind-check:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      AWS_KVS_LOG_LEVEL: 7

    permissions:
      id-token: write
      contents: read
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get -y install valgrind

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.x'

      - name: Build repository
        run: |
          mkdir build && cd build
          cmake .. -DUSE_OPENSSL=OFF -DUSE_MBEDTLS=ON
          make -j

      - name: Run tests
        run: |
          cd build
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes --verbose --log-file=valgrind-master.txt ./samples/kvsWebrtcClientMaster demo-channel-gh-actions &
          PID_MASTER=$!
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes --verbose --log-file=valgrind-viewer.txt ./samples/kvsWebrtcClientViewer demo-channel-gh-actions &
          PID_VIEWER=$!

          # Wait for processes to run initially
          sleep 30 # Wait 30s

          # Send SIGINT (2) to both processes
          kill -2 $PID_VIEWER
          sleep 30

          kill -2 $PID_MASTER

          # Start a background task to enforce a timeout for graceful shutdown
          (
            sleep 10
            kill -9 $PID_MASTER 2>/dev/null
            kill -9 $PID_VIEWER 2>/dev/null
          ) &

          wait $PID_MASTER
          EXIT_STATUS_MASTER=$?
          wait $PID_VIEWER
          EXIT_STATUS_VIEWER=$?

          # Check exit statuses to determine if the interrupt was successful
          if [ $EXIT_STATUS_MASTER -ne 0 ] || [ $EXIT_STATUS_VIEWER -ne 0 ]; then
            echo "Process did not exit gracefully."
            echo "Master exit code: $EXIT_STATUS_MASTER"
            echo "Viewer exit code: $EXIT_STATUS_VIEWER"
            exit 1
          else

            echo "Processes exited successfully."
          fi

          # Check for memory leaks in Valgrind output files
          if grep "All heap blocks were freed -- no leaks are possible" valgrind-master.txt && grep "All heap blocks were freed -- no leaks are possible" valgrind-viewer.txt; then
            echo "No memory leaks detected."
          else
            echo "Memory leaks detected."
          fi
