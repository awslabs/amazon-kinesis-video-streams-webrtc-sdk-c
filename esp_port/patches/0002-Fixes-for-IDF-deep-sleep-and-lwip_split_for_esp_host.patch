From 710c104882cd151c7f461d1cf4dfa01f793fde54 Mon Sep 17 00:00:00 2001
From: Vikram Dattu <vikram.dattu@espressif.com>
Date: Tue, 6 Aug 2024 11:55:22 +0530
Subject: [PATCH 1/2] Fixes for IDF deep sleep and lwip_split_for_esp_hosted

---
 components/lwip/port/include/lwipopts.h       | 46 +++++++++++++++++++
 .../components/cmd_system/cmd_system.c        |  1 +
 .../components/cmd_system/cmd_system_sleep.c  |  6 ++-
 3 files changed, 51 insertions(+), 2 deletions(-)

diff --git a/components/lwip/port/include/lwipopts.h b/components/lwip/port/include/lwipopts.h
index d150106f81..0ec2f3883e 100644
--- a/components/lwip/port/include/lwipopts.h
+++ b/components/lwip/port/include/lwipopts.h
@@ -1673,6 +1673,52 @@ static inline uint32_t timeout_from_offered(uint32_t lease, uint32_t min)
 #define mem_clib_calloc calloc
 #endif /* CONFIG_SPIRAM_TRY_ALLOCATE_WIFI_LWIP */
 
+#ifdef CONFIG_LWIP_TCP_LOCAL_PORT_RANGE_START
+#define TCP_LOCAL_PORT_RANGE_START CONFIG_LWIP_TCP_LOCAL_PORT_RANGE_START
+#define TCP_LOCAL_PORT_RANGE_END   CONFIG_LWIP_TCP_LOCAL_PORT_RANGE_END
+#define TCP_ENSURE_LOCAL_PORT_RANGE(port) ((port)%(TCP_LOCAL_PORT_RANGE_END+1-TCP_LOCAL_PORT_RANGE_START)+TCP_LOCAL_PORT_RANGE_START)
+#if CONFIG_LWIP_TCP_LOCAL_PORT_RANGE_END == 0xffff
+  #define IS_LOCAL_TCP_PORT(port) (port>=TCP_LOCAL_PORT_RANGE_START)
+#else
+  #define IS_LOCAL_TCP_PORT(port) (port>=TCP_LOCAL_PORT_RANGE_START && (port<=CONFIG_LWIP_TCP_LOCAL_PORT_RANGE_END))
+#endif
+#endif
+
+#ifdef CONFIG_LWIP_TCP_REMOTE_PORT_RANGE_START
+#define TCP_REMOTE_PORT_RANGE_START CONFIG_LWIP_TCP_REMOTE_PORT_RANGE_START
+#define TCP_REMOTE_PORT_RANGE_END   CONFIG_LWIP_TCP_REMOTE_PORT_RANGE_END
+#define TCP_ENSURE_REMOTE_PORT_RANGE(port) ((port)%(TCP_REMOTE_PORT_RANGE_END+1-TCP_REMOTE_PORT_RANGE_START)+TCP_REMOTE_PORT_RANGE_START)
+#if CONFIG_LWIP_TCP_REMOTE_PORT_RANGE_END == 0xffff
+  #define IS_REMOTE_TCP_PORT(port) (port>=TCP_REMOTE_PORT_RANGE_START)
+#else
+  #define IS_REMOTE_TCP_PORT(port) (port>=TCP_REMOTE_PORT_RANGE_START && (port<=CONFIG_LWIP_TCP_REMOTE_PORT_RANGE_END))
+#endif
+#endif
+
+#ifdef CONFIG_LWIP_UDP_LOCAL_PORT_RANGE_START
+#define UDP_LOCAL_PORT_RANGE_START CONFIG_LWIP_UDP_LOCAL_PORT_RANGE_START
+#define UDP_LOCAL_PORT_RANGE_END   CONFIG_LWIP_UDP_LOCAL_PORT_RANGE_END
+#define UDP_ENSURE_LOCAL_PORT_RANGE(port) ((u16_t)(((port) & (u16_t)~UDP_LOCAL_PORT_RANGE_START) + UDP_LOCAL_PORT_RANGE_START))
+
+#if CONFIG_LWIP_UDP_LOCAL_PORT_RANGE_END == 0xffff
+  #define IS_LOCAL_UDP_PORT(port) (port>=UDP_LOCAL_PORT_RANGE_START)
+#else
+  #define IS_LOCAL_UDP_PORT(port) (port>=UDP_LOCAL_PORT_RANGE_START && (port<=CONFIG_LWIP_UDP_LOCAL_PORT_RANGE_END))
+#endif
+#define DNS_PORT_ALLOWED(port) IS_LOCAL_UDP_PORT(port)
+#endif
+
+#ifdef CONFIG_LWIP_UDP_REMOTE_PORT_RANGE_START
+#define UDP_REMOTE_PORT_RANGE_START CONFIG_LWIP_UDP_REMOTE_PORT_RANGE_START
+#define UDP_REMOTE_PORT_RANGE_END   CONFIG_LWIP_UDP_REMOTE_PORT_RANGE_END
+#define UDP_ENSURE_REMOTE_PORT_RANGE(port) ((u16_t)(((port) & (u16_t)~UDP_REMOTE_PORT_RANGE_START) + UDP_REMOTE_PORT_RANGE_START))
+
+#if CONFIG_LWIP_UDP_REMOTE_PORT_RANGE_END == 0xffff
+  #define IS_REMOTE_UDP_PORT(port) (port>=UDP_REMOTE_PORT_RANGE_START)
+#else
+  #define IS_REMOTE_UDP_PORT(port) (port>=UDP_REMOTE_PORT_RANGE_START && (port<=CONFIG_LWIP_UDP_REMOTE_PORT_RANGE_END))
+#endif
+#endif
 
 /*
  * Check if the lwIP configuration is sane
diff --git a/examples/system/console/advanced/components/cmd_system/cmd_system.c b/examples/system/console/advanced/components/cmd_system/cmd_system.c
index 761053ff98..f1867e5f96 100644
--- a/examples/system/console/advanced/components/cmd_system/cmd_system.c
+++ b/examples/system/console/advanced/components/cmd_system/cmd_system.c
@@ -10,6 +10,7 @@
 
 #include "cmd_system.h"
 #include "sdkconfig.h"
+#include "soc/soc_caps.h"
 
 void register_system(void)
 {
diff --git a/examples/system/console/advanced/components/cmd_system/cmd_system_sleep.c b/examples/system/console/advanced/components/cmd_system/cmd_system_sleep.c
index 4aad14d6f3..f8bd5c6b7e 100644
--- a/examples/system/console/advanced/components/cmd_system/cmd_system_sleep.c
+++ b/examples/system/console/advanced/components/cmd_system/cmd_system_sleep.c
@@ -29,7 +29,7 @@
 
 static const char *TAG = "cmd_system_sleep";
 
-#if SOC_DEEP_SLEEP_SUPPORTED
+#if CONFIG_SOC_DEEP_SLEEP_SUPPORTED
 /** 'deep_sleep' command puts the chip into deep sleep mode */
 static struct {
     struct arg_int *wakeup_time;
@@ -41,6 +41,7 @@ static struct {
 } deep_sleep_args;
 
 
+extern int send_slave_power_save(int ps);
 static int deep_sleep(int argc, char **argv)
 {
     int nerrors = arg_parse(argc, argv, (void **) &deep_sleep_args);
@@ -80,6 +81,7 @@ static int deep_sleep(int argc, char **argv)
 #if CONFIG_IDF_TARGET_ESP32
     rtc_gpio_isolate(GPIO_NUM_12);
 #endif //CONFIG_IDF_TARGET_ESP32
+	send_slave_power_save(1);
     esp_deep_sleep_start();
     return 1;
 }
@@ -116,7 +118,7 @@ void register_system_deep_sleep(void)
 }
 #endif // SOC_DEEP_SLEEP_SUPPORTED
 
-#if SOC_LIGHT_SLEEP_SUPPORTED
+#if CONFIG_SOC_LIGHT_SLEEP_SUPPORTED
 /** 'light_sleep' command puts the chip into light sleep mode */
 static struct {
     struct arg_int *wakeup_time;
-- 
2.39.3 (Apple Git-146)

